#!/usr/bin/env zsh

set -e

echo "=> Attempting to update Brewfile"

#: Dump updates to Brewfile
echo "  - Dumping new dependencies to {{ .brew.file }}"
[ -f "{{ .brew.file }}" ] && rm {{ .brew.file }}
brew bundle dump --describe --file {{ .brew.file }}

#: Push updates to dotfiles
echo "  - Attempting to update the \`chezmoi\` copy"
chezmoi add {{ .brew.file }}
brewfilePath="$(echo "$(chezmoi source-path {{ .brew.file }})" | sed "s|$(chezmoi source-path)/||g")"
cd $(chezmoi source-path)

#: Add and push to git repo
echo "  - Adding, committing, and pushing"
git add ${brewfilePath}
git commit --no-verify -m "ðŸ“Œ Update Brewfile for {{ .osid }}"
git push -u origin main

echo "  ðŸŽ‰ Completed Brewfile update"
